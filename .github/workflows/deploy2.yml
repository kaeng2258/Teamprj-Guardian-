name: Deploy Backend & Frontend

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build backend JAR
        run: |
          echo "=== repo ë£¨íŠ¸ ë‚´ìš© ==="
          pwd
          ls -l

          chmod +x gradlew
          ./gradlew clean bootJar -x test

          echo "=== build/libs ë‚´ìš© ==="
          ls -l build/libs || echo "âš  build/libs ì—†ìŒ"

      - name: Check built JAR exists
        run: |
          echo "=== JAR ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ==="
          if [ ! -d build/libs ]; then
            echo "âŒ build/libs ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          ls -l build/libs

          if [ ! -f build/libs/guardian-0.0.1-SNAPSHOT.jar ]; then
            echo "âŒ build/libs/guardian-0.0.1-SNAPSHOT.jar íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… JAR íŒŒì¼ ì¡´ìž¬: build/libs/guardian-0.0.1-SNAPSHOT.jar"

      - name: Upload backend JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          source: "build/libs/guardian-0.0.1-SNAPSHOT.jar"
          target: "/home/ec2-user/app/backend/"
          strip_components: 2

      # âœ… ë¡œê·¸ ë³´ê´€ ì œí•œ (ë””í”Œë¡œì´ë§ˆë‹¤ ì‹¤í–‰í•´ë„ ë¬´í•´)
      - name: Configure journald log retention (once)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          command_timeout: 300s
          script: |
            set -e

            echo "=== Configure systemd-journald log limits ==="

            sudo tee /etc/systemd/journald.conf > /dev/null << 'EOF'
            [Journal]
            SystemMaxUse=300M
            SystemMaxFileSize=50M
            MaxRetentionSec=14day
            MaxFileSec=7day
            SystemKeepFree=1G
            EOF

            echo "=== Restart systemd-journald ==="
            sudo systemctl restart systemd-journald

            echo "=== Vacuum old logs ==="
            sudo journalctl --vacuum-size=300M

      # âœ… ë°±ì—… ì—†ì´ guardian.jarë¡œ êµì²´ + ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
      - name: Restart backend service (no backup)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          command_timeout: 600s
          script: |
            set -e
            cd /home/ec2-user/app/backend

            echo "=== EC2 backend ë””ë ‰í† ë¦¬ ë‚´ìš© ==="
            pwd
            ls -l

            # ì—…ë¡œë“œëœ JAR í™•ì¸
            if [ ! -f guardian-0.0.1-SNAPSHOT.jar ]; then
              echo "âŒ ì—…ë¡œë“œëœ guardian-0.0.1-SNAPSHOT.jar ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
              exit 1
            fi

            # ë°±ì—… ì œê±°: ê¸°ì¡´ guardian.jarëŠ” ì‚­ì œ í›„ êµì²´
            rm -f guardian.jar
            mv -f guardian-0.0.1-SNAPSHOT.jar guardian.jar

            echo "=== guardian-backend ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ==="
            sudo systemctl daemon-reload
            sudo systemctl restart guardian-backend
            sudo systemctl status guardian-backend --no-pager -l

  frontend:
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # âœ… frontapp ì†ŒìŠ¤ ì „ì²´ë¥¼ EC2ë¡œ ë³µì‚¬ (EC2ì—ì„œ ë¹Œë“œ)
      - name: Upload frontend to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          source: "frontapp/*"
          target: "/home/ec2-user/app/frontend"

      # âœ… EC2ì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜ + ë¹Œë“œ + ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
      - name: Install deps & restart frontend on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          command_timeout: 900s
          script: |
            set -e
            cd /home/ec2-user/app/frontend/frontapp

            echo "=== EC2 frontend/frontapp ë””ë ‰í† ë¦¬ ë‚´ìš© ==="
            pwd
            ls -l

            echo "=== .env* í™•ì¸ ==="
            ls -l .env* || echo "no env files"

            # ðŸ”¥ í”„ë¡œë•ì…˜ ë¹Œë“œ ì „ì— .env.local ì œê±°
            if [ -f .env.local ]; then
              echo "âš  Removing .env.local for production build"
              rm -f .env.local
            fi

            echo "=== package*.json í™•ì¸ ==="
            ls -l package*.json || echo "âŒ package.json / package-lock.json ì—†ìŒ"

            # ðŸ”¥ devDependencies í¬í•¨ ì„¤ì¹˜ (Tailwind ë“±)
            if [ -f package-lock.json ]; then
              echo "âœ… package-lock.json ì¡´ìž¬ â†’ npm ci"
              npm ci
            else
              echo "âš  package-lock.json ì—†ìŒ â†’ npm install"
              npm install
            fi

            echo "=== Next.js build ==="
            npm run build

            echo "=== guardian-frontend ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ==="
            sudo systemctl daemon-reload
            sudo systemctl restart guardian-frontend
            sudo systemctl status guardian-frontend --no-pager -l

##rebuildtest112
