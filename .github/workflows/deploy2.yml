name: Deploy Backend & Frontend

on:
  push:
    branches: [ "sh4" ]

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
      ...
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

      - name: Build backend JAR
        run: |
          echo "=== repo ë£¨íŠ¸ ë‚´ìš© ==="
          pwd
          ls -l

          chmod +x gradlew
          ./gradlew clean bootJar -x test

          echo "=== build/libs ë‚´ìš© ==="
          ls -l build/libs || echo "âš  build/libs ì—†ìŒ"

      # âœ… ë¹Œë“œ ê²°ê³¼ì— JARì´ ì‹¤ì œë¡œ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸ (ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì‹¤íŒ¨)
      - name: Check built JAR exists
        run: |
          echo "=== JAR ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ==="
          if [ ! -d build/libs ]; then
            echo "âŒ build/libs ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          ls -l build/libs

          JAR_COUNT=$(ls build/libs/*.jar 2>/dev/null | wc -l)
          if [ "$JAR_COUNT" -eq 0 ]; then
            echo "âŒ build/libs ì— .jar íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… build/libs ì— JAR íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤."

      # âœ… ë¹Œë“œëœ JAR ì „ë¶€ EC2ë¡œ ë³µì‚¬
      - name: Upload backend JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          source: "build/libs/*.jar"
          target: "/home/ec2-user/app/backend/"

      # âœ… EC2ì—ì„œ ê°€ì¥ ìµœì‹  JARë¥¼ guardian.jar ë¡œ ì„¤ì • + ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Restart backend service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          command_timeout: 600s
          script: |
            set -e
            cd /home/ec2-user/app/backend

            echo "=== EC2 backend ë””ë ‰í† ë¦¬ ë‚´ìš© ==="
            pwd
            ls -l

            # ê¸°ì¡´ guardian.jar ë°±ì—… (ìˆìœ¼ë©´)
            if [ -f guardian.jar ]; then
              BACKUP_NAME="guardian_backup_$(date +%Y%m%d%H%M%S).jar"
              echo "ê¸°ì¡´ guardian.jar ë°±ì—… â†’ $BACKUP_NAME"
              mv guardian.jar "$BACKUP_NAME"
            fi

            echo "=== ì—…ë¡œë“œëœ JAR ëª©ë¡ ==="
            ls -t *.jar || echo "JAR íŒŒì¼ ì—†ìŒ"

            # ë°©ê¸ˆ ì—…ë¡œë“œëœ JAR ì¤‘ ê°€ì¥ ìµœì‹  íŒŒì¼ ì„ íƒ
            NEW_JAR=$(ls -t *.jar | head -n 1)

            if [ -z "$NEW_JAR" ]; then
              echo "âŒ ìƒˆ JAR íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
              ls -l *.jar || echo "JAR íŒŒì¼ ì—†ìŒ"
              exit 1
            fi

            echo "ìƒˆ JAR íŒŒì¼: $NEW_JAR â†’ guardian.jar ë¡œ ì‚¬ìš©"
            cp "$NEW_JAR" guardian.jar

            echo "=== guardian-backend ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ==="
            sudo systemctl daemon-reload
            sudo systemctl restart guardian-backend
            sudo systemctl status guardian-backend --no-pager -l



  frontend:
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # âœ… ë¡œì»¬ì—ì„œ Next.js ë¹Œë“œ (frontapp í´ë”)
      - name: Install & Build frontend
        working-directory: frontapp
        run: |
          npm ci
          npm run build

          echo "==== frontapp ë””ë ‰í† ë¦¬ ë‚´ìš© ===="
          ls -l
          echo "==== frontapp/.next ë‚´ìš© ===="
          ls -l .next || echo ".next ì—†ìŒ"

      # âœ… ë¹Œë“œëœ frontapp ì „ì²´ë¥¼ EC2ë¡œ ë³µì‚¬
      - name: Upload frontend to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          source: "frontapp/*"
          target: "/home/ec2-user/app/frontend"

      # âœ… EC2ì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜ + ë¹Œë“œ + ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Install deps & restart frontend on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST2 }}
          username: ${{ secrets.EC2_USER2 }}
          key: ${{ secrets.EC2_SSH_KEY2 }}
          command_timeout: 900s
          script: |
            set -e
            cd /home/ec2-user/app/frontend/frontapp

            echo "=== EC2 frontend/frontapp ë””ë ‰í† ë¦¬ ë‚´ìš© ==="
            pwd
            ls -l

            echo "=== .env* í™•ì¸ ==="
            ls -l .env* || echo "no env files"

            # ğŸ”¥ í”„ë¡œë•ì…˜ ë¹Œë“œ ì „ì— .env.local ì œê±°
            if [ -f .env.local ]; then
              echo "âš  Removing .env.local for production build"
              rm -f .env.local
            fi

            echo "=== package*.json í™•ì¸ ==="
            ls -l package*.json || echo "âŒ package.json / package-lock.json ì—†ìŒ"

            # ğŸ”¥ devDependencies í¬í•¨í•´ì„œ ì„¤ì¹˜ (Tailwind ë“±)
            if [ -f package-lock.json ]; then
              echo "âœ… package-lock.json ì¡´ì¬ â†’ npm ci"
              npm ci
            else
              echo "âš  package-lock.json ì—†ìŒ â†’ npm install"
              npm install
            fi

            echo "=== Next.js build ==="
            npm run build

            echo "=== guardian-frontend ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ==="
            sudo systemctl daemon-reload
            sudo systemctl restart guardian-frontend
            sudo systemctl status guardian-frontend --no-pager -l

##rebuild
